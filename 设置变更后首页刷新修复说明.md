# 设置变更后首页刷新修复说明

## 问题描述
用户修改国家/语言/货币设置后，首页和其他相关页面仍然显示之前的数据，没有自动刷新。

## 修复方案
通过在关键页面添加事件监听器，监听设置变更事件，当用户修改设置后自动刷新页面数据。

## 修复的页面

### 1. 首页 (HomeScreen) ✅
**文件**: `/app/screens/HomeScreen/index.tsx`
**修复内容**:
- 监听 `settingsChanged` 和 `refreshSetting` 事件
- 自动刷新推荐数据和分类数据
- 重新获取一级类目（适应语言变更）

### 2. 购物车页面 (CartScreen) ✅
**文件**: `/app/screens/CartScreen/index.tsx`
**修复内容**:
- 监听设置变更事件
- 重新获取购物车数据以更新价格和货币显示
- 确保总金额计算使用最新的汇率

### 3. 分类页面 (CategoryScreen) ✅
**文件**: `/app/screens/CategoryScreen.tsx`
**修复内容**:
- 监听设置变更事件
- 重新获取主分类和子分类数据
- 更新多语言分类名称显示

### 4. 搜索结果页面 (SearchResultScreen) ✅
**文件**: `/app/screens/SearchResultScreen.tsx`
**修复内容**:
- 监听设置变更事件
- 重新执行搜索以获取更新的产品数据
- 更新价格、货币和多语言产品名称显示

## 事件流程

```
用户修改设置 → CountrySetting.tsx
    ↓
触发 eventBus.emit('settingsChanged')
    ↓
各页面监听器收到事件
    ↓
页面自动刷新数据
    ↓
显示更新后的内容
```

## 技术实现

### 事件触发位置
在 `CountrySetting.tsx` 的以下函数中触发：
- `handleCountrySelect()` - 国家变更
- `handleCurrencySelect()` - 货币变更  
- `handleLanguageSelect()` - 语言变更

### 事件监听模式
```typescript
useEffect(() => {
  const handleSettingsChanged = () => {
    console.log('[PageName] 设置发生变更，刷新数据');
    // 重新获取数据的逻辑
    refreshData();
  };

  eventBus.on('settingsChanged', handleSettingsChanged);
  eventBus.on('refreshSetting', handleSettingsChanged);
  
  return () => {
    eventBus.off('settingsChanged', handleSettingsChanged);
    eventBus.off('refreshSetting', handleSettingsChanged);
  };
}, [依赖项]);
```

## 测试方法

1. **语言变更测试**:
   - 进入设置页面修改语言
   - 返回首页检查分类名称是否更新
   - 检查搜索结果页面的产品名称是否更新

2. **货币变更测试**:
   - 进入设置页面修改货币
   - 返回首页检查产品价格货币单位
   - 进入购物车检查总金额和货币显示

3. **国家变更测试**:
   - 进入设置页面修改国家
   - 返回首页检查推荐产品是否更新
   - 检查分类内容是否根据地区调整

## 注意事项

1. **延迟刷新**: 使用 300ms 延迟确保设置完全更新后再刷新数据
2. **事件清理**: 在组件卸载时正确清理事件监听器避免内存泄漏
3. **条件刷新**: 只在有用户ID或相关数据时才执行刷新操作
4. **错误处理**: 在数据获取失败时有适当的错误处理

## 日志输出
修复后会在控制台看到类似日志：
```
[HomeScreen] 设置发生变更，强制刷新首页数据
[HomeScreen] 刷新推荐页面数据
[CartScreen] 设置发生变更，刷新购物车数据
[CategoryScreen] 设置发生变更，刷新分类数据
[SearchResultScreen] 设置发生变更，刷新搜索结果
```

## 未来优化建议

1. **批量更新**: 考虑在短时间内多次设置变更时进行批量更新
2. **缓存机制**: 实现智能缓存机制减少不必要的API调用
3. **loading状态**: 在刷新过程中显示loading状态提升用户体验
4. **错误重试**: 实现数据刷新失败的重试机制

修复完成后，用户修改国家/语言/货币设置后，所有相关页面都会自动刷新显示最新的数据。